name: OpenRouter PR Review and Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
    paths:
      - 'public/data/**'
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: read

jobs:
  openrouter-review:
    # Run on: automated PRs with public/data changes OR manual /review comment
    if: |
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'automated')) ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/review'))
    timeout-minutes: 15
    runs-on: ubuntu-latest

    steps:
      - name: Initial checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr-details
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Direct PR event
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "pr_ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
            echo "is_automated=true" >> $GITHUB_OUTPUT
          else
            # Comment trigger - get PR details from API
            PR_NUMBER=${{ github.event.issue.number }}
            PR_DATA=$(gh pr view $PR_NUMBER --json headRefName,labels)
            PR_REF=$(echo "$PR_DATA" | jq -r '.headRefName')
            HAS_AUTOMATED_LABEL=$(echo "$PR_DATA" | jq -r '[.labels[].name] | contains(["automated"])')

            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "pr_ref=$PR_REF" >> $GITHUB_OUTPUT
            echo "is_automated=$HAS_AUTOMATED_LABEL" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.pr-details.outputs.pr_ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: OpenRouter PR Review
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ vars.OPENROUTER_MODEL || 'anthropic/claude-haiku-4.5:online' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr-details.outputs.pr_number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/openrouter_pr_review.py
          python scripts/openrouter_pr_review.py

      - name: Wait for checks
        if: steps.pr-details.outputs.is_automated == 'true'
        run: |
          echo "Waiting for all checks to complete..."
          sleep 30
          PR_NUMBER="${{ steps.pr-details.outputs.pr_number }}"
          CHECKS_STATUS=$(gh pr checks $PR_NUMBER --json state -q '.[].state' || echo "")
          if echo "$CHECKS_STATUS" | grep -q "FAILURE\|ERROR"; then
            echo "Some checks failed. Will not auto-merge."
            exit 1
          fi
          echo "All checks passed or pending. Proceeding with merge."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge PR
        if: steps.pr-details.outputs.is_automated == 'true'
        run: |
          PR_NUMBER="${{ steps.pr-details.outputs.pr_number }}"
          APPROVALS=$(gh pr view $PR_NUMBER --json reviews -q '[.reviews[] | select(.state == "APPROVED")] | length')
          if [ "$APPROVALS" -gt 0 ]; then
            echo "PR has been approved. Merging..."
            gh pr merge $PR_NUMBER --squash --auto --delete-branch
          else
            echo "PR not approved yet. Skipping auto-merge."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
