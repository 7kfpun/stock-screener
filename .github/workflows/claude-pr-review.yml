name: Claude PR Review and Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: read

jobs:
  claude-review:
    # Only run on PRs with the automated label
    if: contains(github.event.pull_request.labels.*.name, 'automated')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Review this automated daily stock data update PR and generate stock summaries.

            **Your tasks:**

            1. **Verify the changes:**
               - Only CSV files in `public/data/` should be modified
               - Data format is consistent with previous updates
               - No unexpected files were modified
               - dates.csv was properly updated
               - latest.csv matches the dated CSV file

            2. **Generate and save stock summaries:**
               - Read the dated CSV file to get the first 5 tickers
               - Use web search to find current, accurate information about each company
               - For each ticker, create a concise 1-sentence description (max 15 words)
               - Focus on what makes each company notable or their primary business
               - Include any recent significant news if relevant

               - Extract the date from the CSV filename (e.g., "2026-01-07.csv" -> "2026-01-07")
               - Create a JSON file with this structure:
                 {
                   "date": "YYYY-MM-DD",
                   "updated_at": "ISO timestamp",
                   "top_stocks": [
                     {
                       "ticker": "TICKER",
                       "company": "Company Name",
                       "sector": "Sector",
                       "country": "Country",
                       "pe": "P/E ratio",
                       "market_cap": "Market cap",
                       "price": "Price",
                       "change": "Change",
                       "description": "Your generated description"
                     }
                   ]
                 }

               - Save to: public/data/summary/{date}.json (dated file)
               - Save to: public/data/summary/latest.json (latest copy)
               - Commit both files to this PR branch

            3. **Post your review:**
               - Add a comment with:
                 - âœ… Verification summary (what you checked)
                 - ðŸ“Š Top 5 Stocks section with descriptions
                 - ðŸ’¾ Confirmation that summary files were saved
               - If everything looks good: Approve the PR
               - If there are issues: Request changes and explain what's wrong

            **Example comment format:**
            ```
            âœ… **Verification Complete**
            - CSV files updated correctly
            - Data format consistent
            - No unexpected changes

            ðŸ“Š **Top 5 Stocks**
            - **TICKER**: Brief description
            - **TICKER**: Brief description
            ...

            ðŸ’¾ **Summary Files**
            - Saved to public/data/summary/YYYY-MM-DD.json
            - Updated public/data/summary/latest.json
            ```
          claude_args: |
            --allowedTools "Read,Write,WebSearch,Bash(gh pr:*),Bash(git:*)"

      - name: Wait for checks
        if: success()
        run: |
          echo "Waiting for all checks to complete..."
          sleep 30

          # Check if PR checks workflow passed
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Get the latest status of checks
          CHECKS_STATUS=$(gh pr checks $PR_NUMBER --json state -q '.[].state' || echo "")

          if echo "$CHECKS_STATUS" | grep -q "FAILURE\|ERROR"; then
            echo "Some checks failed. Will not auto-merge."
            exit 1
          fi

          echo "All checks passed or pending. Proceeding with merge."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge PR
        if: success()
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Check if Claude approved the PR
          APPROVALS=$(gh pr view $PR_NUMBER --json reviews -q '[.reviews[] | select(.state == "APPROVED")] | length')

          if [ "$APPROVALS" -gt 0 ]; then
            echo "PR has been approved. Merging..."
            gh pr merge $PR_NUMBER --squash --auto --delete-branch
          else
            echo "PR not approved yet. Skipping auto-merge."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
